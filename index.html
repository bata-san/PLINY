<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project: SYNCHRONUS</title>
    <style>
        :root {
            --bg: #121212;
            --surface: #1e1e1e;
            --text-primary: #e0e0e0;
            --text-secondary: #a0a0a0;
            --border: #333;
            --primary: #bb86fc;
            --success: #03dac6;
            --font-system: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }
        body { font-family: var(--font-system); background-color: var(--bg); color: var(--text-primary); margin: 0; padding: 20px; font-size: 16px; }
        #app { max-width: 900px; margin: 0 auto; background: var(--surface); border: 1px solid var(--border); border-radius: 12px; box-shadow: 0 8px 24px rgba(0,0,0,0.5); overflow: hidden; }
        .app-header { padding: 20px 30px; background-color: rgba(0,0,0,0.2); border-bottom: 1px solid var(--border); }
        .app-header h1 { font-size: 1.8em; margin: 0; color: var(--primary); text-align: center; }
        .app-body { padding: 30px; }
        #task-input-form { display: flex; gap: 10px; margin-bottom: 20px; }
        #task-content, #task-due-date { background: var(--bg); color: var(--text-primary); border: 1px solid var(--border); border-radius: 8px; padding: 12px; font-size: 1em; }
        #task-content { flex-grow: 1; }
        #task-due-date { width: 150px; }
        #add-task-btn { background-color: var(--primary); color: var(--bg); border: none; padding: 0 20px; border-radius: 8px; font-weight: 700; cursor: pointer; }
        #task-list { list-style: none; padding: 0; margin: 0; }
        .task-item { display: flex; align-items: center; padding: 15px 10px; border-bottom: 1px solid var(--border); transition: background-color 0.2s; }
        .task-item:hover { background-color: rgba(255,255,255,0.05); }
        .task-item:last-child { border-bottom: none; }
        .task-item input[type="checkbox"] { width: 20px; height: 20px; accent-color: var(--primary); margin-right: 15px; flex-shrink: 0; }
        .task-details { flex-grow: 1; }
        .task-content-text { word-break: break-all; }
        .task-item.completed .task-content-text { text-decoration: line-through; color: var(--text-secondary); }
        .task-due-date-text { font-size: 0.8em; color: var(--text-secondary); margin-top: 4px; }
        .overdue { color: #cf6679; font-weight: bold; }
        .delete-btn { background: none; border: none; color: var(--text-secondary); font-size: 1.2em; cursor: pointer; }
    </style>
</head>
<body>
    <div id="app">
        <div class="app-header"><h1>SYNCHRONUS</h1></div>
        <div class="app-body">
            <form id="task-input-form">
                <input type="text" id="task-content" placeholder="やるべきこと" required>
                <input type="date" id="task-due-date">
                <button id="add-task-btn" type="submit">追加</button>
            </form>
            <ul id="task-list"></ul>
        </div>
    </div>
<script>
// --- Project: SYNCHRONUS - Frontend Logic ---
document.addEventListener('DOMContentLoaded', () => {
    const API_ENDPOINT = '/api/tasks';
    const taskForm = document.getElementById('task-input-form');
    const taskContentInput = document.getElementById('task-content');
    const taskDueDateInput = document.getElementById('task-due-date');
    const taskList = document.getElementById('task-list');

    const fetchAndRenderTasks = async () => {
        try {
            const response = await fetch(API_ENDPOINT);
            if (!response.ok) throw new Error('APIからのデータ取得に失敗した…');
            const tasks = await response.json();
            
            tasks.sort((a, b) => (a.dueDate || '9999-99-99').localeCompare(b.dueDate || '9999-99-99'));

            taskList.innerHTML = '';
            if (tasks.length === 0) {
                taskList.innerHTML = '<li>タスクはない。新しいミッションを創造しろ。</li>';
                return;
            }

            tasks.forEach(task => {
                const li = document.createElement('li');
                li.className = 'task-item';
                li.dataset.id = task.id;
                if(task.completed) li.classList.add('completed');
                
                const today = new Date().toISOString().split('T')[0];
                const dueDateText = task.dueDate ? `期限: ${task.dueDate}` : '期限なし';
                const isOverdue = task.dueDate && !task.completed && task.dueDate < today;

                li.innerHTML = `
                    <input type="checkbox" ${task.completed ? 'checked' : ''}>
                    <div class="task-details">
                        <span class="task-content-text">${escapeHTML(task.content)}</span>
                        <div class="task-due-date-text ${isOverdue ? 'overdue' : ''}">${dueDateText}</div>
                    </div>
                    <button class="delete-btn">×</button>
                `;
                taskList.appendChild(li);
            });
        } catch (error) {
            console.error('エラー:', error);
            taskList.innerHTML = `<li>エラー発生: ${error.message}</li>`;
        }
    };

    taskForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const content = taskContentInput.value.trim();
        const dueDate = taskDueDateInput.value;
        if (!content) return;

        try {
            const response = await fetch(API_ENDPOINT, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ content, dueDate: dueDate || null }),
            });
            if (!response.ok) throw new Error('タスクの追加に失敗した…');
            taskContentInput.value = '';
            taskDueDateInput.value = '';
            fetchAndRenderTasks();
        } catch (error) {
            console.error('エラー:', error);
            alert(`エラー: ${error.message}`);
        }
    });

    taskList.addEventListener('click', async (e) => {
        const target = e.target;
        const li = target.closest('.task-item');
        if (!li) return;
        const id = li.dataset.id;
        
        if (target.type === 'checkbox') {
            try {
                const response = await fetch(API_ENDPOINT, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id, completed: target.checked }),
                });
                if (!response.ok) throw new Error('タスクの更新に失敗した…');
                fetchAndRenderTasks();
            } catch(error) {
                console.error('エラー:', error);
                alert(`エラー: ${error.message}`);
            }
        }
        
        if (target.matches('.delete-btn')) {
             if (confirm('このタスクを完全に消去する。いいか？')) {
                try {
                    const response = await fetch(API_ENDPOINT, {
                        method: 'DELETE',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ id }),
                    });
                    if (!response.ok) throw new Error('タスクの削除に失敗した…');
                    fetchAndRenderTasks();
                } catch(error) {
                    console.error('エラー:', error);
                    alert(`エラー: ${error.message}`);
                }
            }
        }
    });

    function escapeHTML(str) {
        return str.replace(/[&<>"']/g, match => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[match]));
    }
    
    fetchAndRenderTasks();
});
</script>
</body>
</html>